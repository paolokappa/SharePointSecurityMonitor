name: PowerShell Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Run PSScriptAnalyzer
      shell: pwsh
      run: |
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
        $results = Invoke-ScriptAnalyzer -Path . -Recurse -ExcludeRule PSAvoidUsingWriteHost
        if ($results) {
          $results
          throw "PSScriptAnalyzer found issues"
        }
    
    - name: Test Installation Script
      shell: pwsh
      run: |
        # Test parameter validation
        .\Install-SharePointSecurityMonitor.ps1 -WhatIf
        
    - name: Validate Scripts Syntax
      shell: pwsh
      run: |
        Get-ChildItem -Path . -Filter *.ps1 -Recurse | ForEach-Object {
          $null = [System.Management.Automation.Language.Parser]::ParseFile($_.FullName, [ref]$null, [ref]$null)
          Write-Host "âœ“ $($_.Name) syntax is valid"
        }
